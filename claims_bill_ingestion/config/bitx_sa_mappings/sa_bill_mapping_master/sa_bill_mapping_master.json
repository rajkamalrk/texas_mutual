{"datacatalog_schema_name":"bill_ingestion_sa_mappings","datacatalog_bill_mapping_table_name":"sa_mapping_bill_config","df_table_name_head":"bill_header_vw","df_table_name_detail":"bill_detail_vw","df_table_name_bu":"bill_bu_vw","db_read_sql_select_head":"WITH freq AS ( SELECT bill_id ,txm_invoice_number ,COALESCE(EIBLTP,'') AS EIBLTP ,CASE WHEN ((EIBLTP >= 110 and EIBLTP <= 129) OR (EIBLTP >= 150 AND EIBLTP <= 189) OR (EIBLTP >= 210 AND EIBLTP <= 229) OR (EIBLTP >= 250 AND EIBLTP <= 289) OR (EIBLTP >= 310 AND EIBLTP <= 329) OR (EIBLTP >= 350 AND EIBLTP <= 389) OR (EIBLTP >= 410 AND EIBLTP <= 429) OR (EIBLTP >= 450 AND EIBLTP <= 489) OR (EIBLTP >= 510 AND EIBLTP <= 529) OR (EIBLTP >= 550 AND EIBLTP <= 589) OR (EIBLTP >= 610 AND EIBLTP <= 629) OR (EIBLTP >= 650 AND EIBLTP <= 689) OR (EIBLTP >= 810 AND EIBLTP <= 829)) THEN 21 WHEN  (EIBLTP >= 230 AND EIBLTP <= 239) THEN 31 WHEN  (EIBLTP >= 850 AND EIBLTP <= 859) THEN 22 WHEN  (EIBLTP >= 330 AND EIBLTP <= 339) THEN 12 ELSE 22 END AS new_pos FROM (SELECT bh.bill_id ,txm_invoice_number ,CASE WHEN TRIM(UPPER(bh.source)) = 'KOFAX' THEN COALESCE(hp.type_of_bill,'')  ELSE CAST(CONCAT(facility_code,bill_frequency_type_code) AS signed) END AS EIBLTP FROM  txm_bitx.bill_header bh LEFT OUTER JOIN txm_bitx.hospitalization_treatment hp ON hp.bill_id=bh.bill_id AND TRIM(UPPER(bh.source)) = 'KOFAX' WHERE txm_invoice_number IN ( SELECT txm_invoice_number FROM txm_bitx.invoice_status WHERE status_type='ADJUDICATION' AND status='READY_FOR_SUBMISSION' ) AND txm_invoice_number IS NOT NULL AND file_header_id IS NOT NULL ) q ), charges AS ( SELECT qq.bill_id ,COALESCE(qq.revenue_code,'') revenue_code ,CASE WHEN (revenue_code >= 360 AND revenue_code <= 369) THEN 'Y' ELSE '' END AS Rev36x ,CASE WHEN (revenue_code >= 100 AND revenue_code <= 169) THEN 'Y' ELSE '' END AS RoomChg ,CASE WHEN (revenue_code = 100 OR revenue_code = 128 OR revenue_code = 138 OR revenue_code = 148 OR revenue_code = 158 OR revenue_code = 911 OR revenue_code = 943 OR revenue_code = 944 OR revenue_code = 945 OR (revenue_code >= 9033 AND revenue_code <= 9044)) THEN 'Y' ELSE '' END AS  RevRehab FROM ( SELECT q.bill_id ,htl.revenue_code FROM (SELECT  bh.bill_id ,txm_invoice_number ,COALESCE(CAST(CONCAT(facility_code,bill_frequency_type_code) AS signed),'') AS EIBLTP FROM  txm_bitx.bill_header bh WHERE txm_invoice_number IN ( SELECT txm_invoice_number FROM txm_bitx.invoice_status WHERE status_type='ADJUDICATION' AND status='READY_FOR_SUBMISSION' ) AND txm_invoice_number IS NOT NULL AND file_header_id IS NOT NULL ) q LEFT OUTER JOIN txm_bitx.hospitalization_treatment ht ON ht.bill_id=q.bill_id LEFT OUTER JOIN txm_bitx.hospitalization_treatment_line htl ON htl.hospitalization_treatment_id=ht.hospitalization_treatment_id WHERE htl.revenue_code <> '' AND revenue_code IS NOT NULL ) qq ) , codes AS ( SELECT   bill_id ,new_pos ,EIBLTP ,type_of_service ,rw ,revenue_code FROM (SELECT  bill_id ,new_pos ,type_of_service ,EIBLTP ,revenue_code ,ROW_NUMBER() OVER (PARTITION BY bill_id ORDER BY priority) AS rw FROM (SELECT DISTINCT  bh.bill_id,new_pos,EIBLTP,revenue_code, CASE  WHEN Rev36x = 'Y' and TRIM(RoomChg)= '' AND (EIBLTP >= 130 AND EIBLTP <= 139) THEN 'HS' WHEN new_pos <> 21 THEN 'HO' WHEN Rev36x = 'Y' AND  (EIBLTP >= 110 AND EIBLTP <= 119) THEN  'IS' WHEN RevRehab = 'Y' AND new_pos = 21 THEN 'IR' WHEN new_pos = 21 THEN 'IM' END AS type_of_service, CASE  WHEN Rev36x = 'Y' and TRIM(RoomChg)= '' AND (EIBLTP >= 130 AND EIBLTP <= 139) THEN 1 WHEN new_pos <> 21 THEN 2 WHEN Rev36x = 'Y' AND  (EIBLTP >= 110 AND EIBLTP <= 119) THEN  3 WHEN RevRehab = 'Y' AND new_pos = 21 THEN 4 WHEN new_pos = 21 THEN 'IM' END AS priority FROM txm_bitx.bill_header bh JOIN charges c ON c.bill_id=bh.bill_id JOIN freq f ON f.bill_id=bh.bill_id )A )QQQ  WHERE rw=1 ) SELECT   bh.bill_id ,bh.trading_partner ,COALESCE(bh.form_type,bdo.txm_doc_type) as form_type ,bh.file_header_id ,bh.source ,facility_code ,bill_frequency_type_code ,codes.revenue_code ,CASE WHEN TRIM(bh.txm_claim_secure)='0' AND TRIM(UPPER(bh.txm_jurisdiction_code)) IN ('JA','LS') THEN  'TXLS' WHEN TRIM(bh.txm_claim_secure)='0' AND TRIM(UPPER(bh.txm_jurisdiction_code))='TX' THEN 'TX35' ELSE 'TX18' END AS Client_Code ,COALESCE(SUBSTRING(UPPER(ht.admission_source),1,1),'') AS admission_source ,COALESCE(SUBSTRING(UPPER(admission_type),1,1),'') AS admission_type ,CASE WHEN TRIM(UPPER(bh.form_type))='PROF' AND LOWER(bh.trading_partner)='jopari'  THEN COALESCE(DATE_FORMAT(pt.from_service_date,'%Y%m%d'),'') WHEN TRIM(UPPER(bh.form_type))='PROF' AND LOWER(TRIM(bh.trading_partner)) IN ('align','techhealth')  THEN COALESCE(DATE_FORMAT(kptl.service_date_from,'%Y%m%d'),'') WHEN  TRIM(UPPER(bh.form_type)) IN ('INST','H') THEN COALESCE(DATE_FORMAT(COALESCE(ht.from_service_bill_date,ht.admission_date),'%Y%m%d'),'') WHEN  TRIM(UPPER(bh.form_type)) IN ('RX','P') AND LOWER(bh.trading_partner)='jopari' THEN COALESCE(DATE_FORMAT(dates_rx.admit_date,'%Y%m%d'),'') ELSE '' END AS admission_date ,COALESCE(SUBSTRING(admission_hour,1,2),'') AS admission_hour ,'' AS App_Benefits ,CASE WHEN LOWER(TRIM(bh.trading_partner)) IN ('align','techhealth','optum') THEN 'P' ELSE ''  END AS Already_Repriced_Flag ,CASE WHEN LOWER(bh.trading_partner) ='jopari' THEN COALESCE(bc.diagnosis_code,'') WHEN TRIM(UPPER(bh.source)) = 'KOFAX' THEN  COALESCE(bc2.diagnosis_code,'') WHEN LOWER(TRIM(bh.trading_partner)) IN ('align','techhealth')  THEN COALESCE(bc2.diagnosis_code,'') ELSE '' END AS  diagnosis_codes ,CASE WHEN TRIM(UPPER(bh.form_type)) IN ('INST','H') AND LOWER(bh.trading_partner) ='jopari' THEN COALESCE(icd_codes.ICD_Procedure_Code,'') WHEN TRIM(UPPER(bh.form_type)) IN ('INST','H') AND TRIM(UPPER(bh.source)) = 'KOFAX' THEN COALESCE(icd_codes_ocr.ICD_Procedure_Code,'') ELSE '' END AS ICD_Procedure_Code ,COALESCE(SUBSTRING(CAST(bh.txm_invoice_number AS CHAR(50)),1,50),'')  AS txm_invoice_number ,COALESCE(SUBSTRING(CAST(bh.txm_claim_number AS CHAR(35)),1,35),'') AS  txm_claim_number ,CASE WHEN LOWER(TRIM(bh.trading_partner)) IN ('align','techhealth','jopari','optum')  THEN  'EDI' WHEN TRIM(UPPER(bh.source)) = 'KOFAX' THEN CASE WHEN TRIM(UPPER(txm_doc_type)) ='RFND' THEN 'RFND' WHEN TRIM(special_handling)='1' THEN 'VRS' ELSE 'OCR' END WHEN TRIM(UPPER(bh.source)) ='ECI' THEN IF(TRIM(UPPER(txm_doc_type)) ='RFND','RFND','KFI') END AS  Client_TOB ,CASE WHEN  TRIM(UPPER(bh.form_type))='PROF' AND LOWER(bh.trading_partner) ='jopari'  THEN COALESCE(DATE_FORMAT(pt.thru_service_date,'%Y%m%d'),'') WHEN  TRIM(UPPER(bh.form_type))='PROF' AND LOWER(TRIM(bh.trading_partner)) IN ('align','techhealth')  THEN COALESCE(DATE_FORMAT(kptl.service_date_from,'%Y%m%d'),'') WHEN  TRIM(UPPER(bh.form_type)) IN ('INST','H') THEN COALESCE(DATE_FORMAT(thru_service_bill_date ,'%Y%m%d'),'') WHEN  TRIM(UPPER(bh.form_type)) IN ('RX','P') AND LOWER(bh.trading_partner)='jopari' THEN COALESCE(DATE_FORMAT(dates_rx.discharge_date,'%Y%m%d'),'') ELSE '' END AS  discharge_date ,CASE WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN ('INST','H') THEN IF(ht.discharge_hour <> 00 AND ht.discharge_hour!='',COALESCE(SUBSTRING(ht.discharge_hour,1,3),''),'') ELSE '' END AS discharge_hour ,COALESCE(DATE_FORMAT(date_of_injury,'%Y%m%d'),'') AS date_of_injury ,COALESCE(SUBSTRING(UPPER(ht.pps_code),1,3),'') AS pps_code ,COALESCE(DATE_FORMAT(convert_tz(now(),'UTC','US/Central'),'%Y%m%d'),'')  AS Due_Date ,CASE WHEN TRIM(UPPER(bh.source)) ='ECI' THEN '99999999999999999999' ELSE  COALESCE(SUBSTRING(pr.provider_number,1,30),'') END AS provider_number ,CASE WHEN TRIM(LOWER(bh.trading_partner))='optum' THEN COALESCE(SUBSTRING(LPAD(CAST((pl.cost_amount+pl.tax_amount)*100 AS SIGNED),9,0),1,9),'') WHEN LOWER(TRIM(bh.trading_partner)) IN ('align','techhealth')  THEN  COALESCE(Retail_PPO_Fees,'') ELSE '' END AS Retail_PPO_Fees ,CASE WHEN TRIM(LOWER(bh.trading_partner))='jopari' THEN '' WHEN LOWER(TRIM(bh.trading_partner)) IN ('align','techhealth','optum') THEN 'Y' ELSE '' END AS Fee_Override ,CASE WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type))='PROF'  THEN COALESCE(SUBSTRING(UPPER(p.patient_account_number),1,20),'') WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type))IN ('INST','H')  THEN COALESCE(SUBSTRING(UPPER(p.patient_control_number),1,20),'') WHEN LOWER(bh.trading_partner) IN ('align','techhealth') THEN COALESCE(SUBSTRING(UPPER(bh.unique_bill_id),1,20),'') WHEN LOWER(bh.source)='kofax' AND TRIM(UPPER(bh.form_type))='PROF'  THEN COALESCE(SUBSTRING(UPPER(p.patient_account_number),1,20),'') WHEN LOWER(bh.source)='kofax' AND TRIM(UPPER(bh.form_type))IN ('INST','H')  THEN COALESCE(SUBSTRING(UPPER(p.patient_control_number),1,20),'') WHEN  LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type))='RX'  THEN COALESCE(SUBSTRING(UPPER(bh.document_control_number),1,20),'') ELSE '' END AS Patient_Account_Number ,COALESCE(SUBSTRING(UPPER(patient_discharge_status),1,2),'') AS Patient_Status ,'' AS Payment_Auth ,CASE WHEN TRIM(UPPER(bh.form_type))='PROF' THEN COALESCE(SUBSTRING(ptl.place_of_service_code,1,2),'') WHEN TRIM(UPPER(bh.form_type))='RX' THEN '01' WHEN TRIM(UPPER(bh.form_type))='INST' THEN CASE WHEN codes.EIBLTP >= 320 AND codes.EIBLTP <= 349 THEN 12 ELSE COALESCE(codes.new_pos,'') END WHEN LOWER(bh.source)='kofax' AND TRIM(UPPER(bh.form_type))='PROF' THEN COALESCE(SUBSTRING( ptl.place_of_service_code,1,2),'') ELSE '' END AS place_of_service_code ,CASE WHEN LOWER(bh.trading_partner) ='align' THEN 'ALIGN NETWORKS, INC.' WHEN LOWER(bh.trading_partner) ='techhealth' THEN 'TECHHEALTH' WHEN LOWER(bh.trading_partner) ='optum' THEN '1E001'ELSE '' END AS PPO_Contract_ID ,CASE WHEN LOWER(bh.trading_partner) ='align' THEN '1G' WHEN LOWER(bh.trading_partner) ='techhealth' THEN 'TI' WHEN LOWER(bh.trading_partner) ='optum' THEN '1E'ELSE '' END AS PPO_Network_ID ,CASE WHEN TRIM(UPPER(bh.form_type)) IN ('P','PROF') THEN COALESCE(SUBSTRING(mp.rendering_provider_license,1,30),'') WHEN TRIM(UPPER(bh.form_type)) IN ('INST', 'H') THEN COALESCE(SUBSTRING(mp.rendering_provider_license, 1, 30),'NO NUMBER') ELSE '' END AS Rendering_Provider_License_Number ,CASE WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN ('INST','H') THEN COALESCE(SUBSTRING(mp.rendering_provider_license, 1, 30),'NO NUMBER') WHEN TRIM(UPPER(bh.source)) = 'KOFAX' AND TRIM(UPPER(bh.form_type)) IN ('INST','H') THEN IF(TRIM(pr.vendor_other_id) <> '',COALESCE(SUBSTRING(UPPER(pr.vendor_other_id),1,30),'NO NUMBER'),'NO NUMBER') ELSE '' END AS Provider_Medicare_Number ,CASE WHEN TRIM(UPPER(bh.form_type))='INST' AND (codes.EIBLTP >= 320 AND codes.EIBLTP <= 349) THEN 'HH' ELSE COALESCE(SUBSTRING(UPPER(mp.provider_type_code),1,2),'') END AS Rendering_Provider_Type ,SUBSTRING(COALESCE(REPLACE(UPPER(mp.facility_zip_code),'-',''),''),1,10) AS Rendering_Provider_Zip ,CASE WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(bh.original_reference_number) IS NOT NULL AND TRIM(bh.original_reference_number) <> '' THEN 'Y' WHEN LOWER(bh.source)='kofax' AND TRIM(bh.original_reference_number) IS NOT NULL AND TRIM(bh.original_reference_number) <> '' THEN 'Y' WHEN TRIM(UPPER(bh.source)) ='ECI' THEN  CASE  WHEN TRIM(UPPER(txm_doc_type)) IN ('RSBILL','RSBILL3','RFND') THEN 'Y' Else '' END ELSE '' END AS Reeval_Flag ,CASE WHEN LOWER(bh.trading_partner) ='optum' THEN  COALESCE(DATE_FORMAT(convert_tz(bh.create_timestamp,'UTC','US/Central'),'%Y%m%d'),'') ELSE '' END AS Repriced_Review_Date ,CASE WHEN LOWER(bh.trading_partner) ='optum' THEN COALESCE(DATE_FORMAT(pl.bill_calculation_date,'%Y%m%d'),'') WHEN LOWER(bh.trading_partner)='jopari' THEN COALESCE(DATE_FORMAT(convert_tz(now(),'UTC','US/Central'),'%Y%m%d'),'') WHEN TRIM(UPPER(bh.source)) = 'KOFAX' THEN COALESCE(DATE_FORMAT(convert_tz(now(),'UTC','US/Central'),'%Y%m%d'),'') WHEN TRIM(UPPER(bh.source)) ='ECI' THEN COALESCE(DATE_FORMAT(convert_tz(now(),'UTC','US/Central'),'%Y%m%d'),'') ELSE '' END AS Bill_Review_Received_Date ,CASE WHEN LOWER(bh.trading_partner) ='optum' THEN COALESCE(DATE_FORMAT(pl.bill_calculation_date,'%Y%m%d'),'') WHEN LOWER(bh.trading_partner) IN ('align','techhealth') THEN COALESCE(DATE_FORMAT(bh.date_bill_received_by_payer,'%Y%m%d'),'') ELSE COALESCE(DATE_FORMAT(bh.date_bill_received_by_payer,'%Y%m%d'),'')  END AS Received_Date ,CASE WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN ('PROF','INST','H','RX','P') THEN COALESCE(DATE_FORMAT(bh.date_of_bill,'%Y%m%d'),'') WHEN LOWER(TRIM(bh.trading_partner)) IN ('align','techhealth') THEN COALESCE(DATE_FORMAT(bh.invoice_date,'%Y%m%d'),'') WHEN TRIM(UPPER(bh.source)) = 'KOFAX' AND TRIM(UPPER(bh.form_type))='PROF' THEN COALESCE(DATE_FORMAT(bh.date_of_bill,'%Y%m%d'),'') WHEN TRIM(UPPER(bh.source)) = 'KOFAX' AND TRIM(UPPER(bh.form_type))='INST' THEN COALESCE(DATE_FORMAT(bh.date_of_bill,'%Y%m%d'),'') WHEN TRIM(UPPER(bh.source)) = 'KOFAX' AND TRIM(UPPER(bh.form_type))='RX' THEN COALESCE(DATE_FORMAT(bh.date_of_bill,'%Y%m%d'),'') ELSE COALESCE(DATE_FORMAT(bh.date_bill_received_by_payer,'%Y%m%d'),'') END  AS Submit_Date ,CASE WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN ('INST','H') THEN IF(TRIM(referring_record_type_physician_code) IN ('20_DN','20_71'),COALESCE(SUBSTRING(UPPER(pr.referring_provider_name),1,30),''),'') ELSE COALESCE(SUBSTRING(UPPER(pr.referring_provider_name),1,30),'') END AS Referring_Provider_Name ,CASE WHEN TRIM(UPPER(bh.form_type)) IN ('INST','H') AND ((CAST(CONCAT(facility_code,bill_frequency_type_code) AS signed) >= 110 AND CAST(CONCAT(facility_code,bill_frequency_type_code) AS signed) <=119) OR (CAST(CONCAT(facility_code,bill_frequency_type_code) AS signed) >= 180 AND CAST(CONCAT(facility_code,bill_frequency_type_code) AS signed) <=189) OR (CAST(CONCAT(facility_code,bill_frequency_type_code) AS signed) >= 210 AND CAST(CONCAT(facility_code,bill_frequency_type_code) AS signed) <=219) OR (CAST(CONCAT(facility_code,bill_frequency_type_code) AS signed) >= 410 AND CAST(CONCAT(facility_code,bill_frequency_type_code) AS signed) <=419) OR (CAST(CONCAT(facility_code,bill_frequency_type_code) AS signed) >= 650 AND CAST(CONCAT(facility_code,bill_frequency_type_code) AS signed) <=659) ) THEN  'I' WHEN TRIM(UPPER(bh.form_type)) IN ('PROF') THEN 'M' WHEN TRIM(UPPER(bh.form_type)) IN ('RX','P') THEN 'P' ELSE 'O' END AS TOB_Type_of_Bill ,CASE WHEN TRIM(UPPER(bh.form_type)) IN ('INST','H')  THEN COALESCE(SUBSTRING(codes.type_of_service,1,2),'') ELSE '' END AS type_of_service ,CASE WHEN TRIM(UPPER(bh.form_type)) IN ('INST','H') AND LOWER(bh.trading_partner)='jopari' THEN COALESCE(SUBSTRING(CONCAT(bh.facility_code,bh.bill_frequency_type_code) ,1,3),'') WHEN TRIM(UPPER(bh.source)) = 'KOFAX' AND TRIM(UPPER(bh.form_type)) IN ('INST','H') THEN COALESCE(SUBSTRING(ht.type_of_bill,1,3),'') ELSE '' END AS UB04_TOB_type_of_Bill ,COALESCE(SUBSTRING(UPPER(mp.vendor_address1),1,30),'') AS Billing_Pay_To_Provider_Billing_Address_one ,COALESCE(SUBSTRING(UPPER(mp.vendor_address2),1,30),'') AS Billing_Pay_To_Provider_Billing_Address_two ,COALESCE(SUBSTRING(UPPER(mp.vendor_city),1,20),'') AS Billing_Pay_To_Provider_Billing_City ,CASE WHEN mp.vendor_phone=0 THEN ''  ELSE COALESCE(SUBSTRING(UPPER(mp.vendor_phone),1,10),'') END AS Billing_Pay_To_Provider_Billing_Phone ,COALESCE(SUBSTRING(UPPER(mp.vendor_state),1,2),'')  AS Billing_Pay_To_Provider_Billing_State ,CASE WHEN  TRIM(UPPER(bh.source)) ='ECI' THEN '000000000' ELSE SUBSTRING(COALESCE(REPLACE(UPPER(mp.vendor_zip_code),'-',''),''),1,10) END AS Billing_Pay_To_Provider_Billing_Zip ,CASE WHEN TRIM(UPPER(bh.form_type)) IN ('PROF') AND LOWER(TRIM(bh.trading_partner)) IN ('align','techhealth') THEN COALESCE(SUBSTRING(UPPER(pr.rendering_provider_name),1,30),'') WHEN TRIM(UPPER(bh.form_type)) IN ('PROF','INST','H') AND LOWER(TRIM(bh.trading_partner)) IN ('jopari') THEN COALESCE(SUBSTRING(UPPER(pr.rendering_provider_name),1,30),'') WHEN TRIM(UPPER(bh.form_type)) IN ('RX','P') AND LOWER(TRIM(bh.trading_partner)) IN ('optum') THEN COALESCE(SUBSTRING(UPPER(pr.rendering_provider_name),1,30),'') WHEN TRIM(UPPER(bh.form_type)) IN ('RX','P') AND LOWER(TRIM(bh.trading_partner)) IN ('jopari') THEN COALESCE(SUBSTRING(UPPER(pr.rendering_provider_name),1,30),'') WHEN  TRIM(UPPER(bh.source)) = 'KOFAX' THEN COALESCE(SUBSTRING(UPPER(pr.rendering_provider_name),1,30),'') ELSE COALESCE(SUBSTRING(UPPER(pr.vendor_name),1,30),'') END AS Billing_Pay_To_Provider_Group ,COALESCE(SUBSTRING(UPPER(mp.facility_address_1),1,30),'') AS Billing_Pay_To_Provider_Practice_Address_one ,COALESCE(SUBSTRING(UPPER(mp.facility_address_2),1,30),'') AS Billing_Pay_To_Provider_Practice_Address_two ,COALESCE(SUBSTRING(UPPER(mp.facility_City),1,20),'') AS Billing_Pay_To_Provider_Practice_City ,COALESCE(SUBSTRING(UPPER(mp.facility_State),1,2),'') AS Billing_Pay_To_Provider_Practice_State ,SUBSTRING(COALESCE(REPLACE(UPPER(mp.facility_zip_code),'-',''),''),1,10) AS Billing_Pay_To_Provider_Practice_Zip ,COALESCE(SUBSTRING(mp.vendor_tax_id,1,9),'') AS Billing_Pay_To_Provider_TIN ,COALESCE(UPPER(TRIM(mp.rendering_provider_name)),'') AS Rendering_Provider_First_Name ,COALESCE(UPPER(TRIM(mp.rendering_provider_name)),'') AS Rendering_Provider_Last_Name ,COALESCE(UPPER(TRIM(mp.rendering_provider_name)),'') AS Rendering_Provider_Middle_Initial ,COALESCE(bh.provider_signature_indicator,'') AS Provider_Signature_on_File ,CASE WHEN pd1.sequence_number=1 AND LOWER(bh.trading_partner)='jopari' THEN COALESCE(DATE_FORMAT(pd1.procedure_date,'%Y%m%d'),'00000000') WHEN pd1_ocr.sequence_number=1 AND TRIM(UPPER(bh.source)) = 'KOFAX' THEN COALESCE(DATE_FORMAT(pd1_ocr.procedure_date,'%Y%m%d'),'00000000') WHEN pd1.sequence_number=1 AND TRIM(UPPER(bh.source)) ='ECI' THEN '' ELSE '00000000' END AS Principal_Procedure_Code_Date ,CASE WHEN pd2.sequence_number=2 AND LOWER(bh.trading_partner)='jopari' THEN COALESCE(DATE_FORMAT(pd2.procedure_date,'%Y%m%d'),'00000000') WHEN pd2_ocr.sequence_number=2 AND TRIM(UPPER(bh.source)) = 'KOFAX' THEN COALESCE(DATE_FORMAT(pd2_ocr.procedure_date,'%Y%m%d'),'00000000') WHEN pd2.sequence_number=2 AND TRIM(UPPER(bh.source)) ='ECI' THEN '' ELSE '00000000' END AS Other_Procedure_Code_Date_2 ,CASE WHEN pd3.sequence_number=3 AND LOWER(bh.trading_partner)='jopari' THEN COALESCE(DATE_FORMAT(pd3.procedure_date,'%Y%m%d'),'00000000') WHEN pd3_ocr.sequence_number=3 AND TRIM(UPPER(bh.source)) = 'KOFAX' THEN COALESCE(DATE_FORMAT(pd3_ocr.procedure_date,'%Y%m%d'),'00000000') WHEN pd3.sequence_number=3 AND TRIM(UPPER(bh.source)) ='ECI' THEN '' ELSE '00000000' END AS Other_Procedure_Code_Date_3 ,CASE WHEN pd4.sequence_number=4 AND LOWER(bh.trading_partner)='jopari' THEN COALESCE(DATE_FORMAT(pd4.procedure_date,'%Y%m%d'),'00000000') WHEN pd4_ocr.sequence_number=4 AND TRIM(UPPER(bh.source)) = 'KOFAX' THEN COALESCE(DATE_FORMAT(pd4_ocr.procedure_date,'%Y%m%d'),'00000000') WHEN pd4.sequence_number=4 AND TRIM(UPPER(bh.source)) ='ECI' THEN '' ELSE '00000000' END AS Other_Procedure_Code_Date_4 ,CASE WHEN pd5.sequence_number=5 AND LOWER(bh.trading_partner)='jopari' THEN COALESCE(DATE_FORMAT(pd5.procedure_date,'%Y%m%d'),'00000000') WHEN pd5_ocr.sequence_number=5 AND TRIM(UPPER(bh.source)) = 'KOFAX' THEN COALESCE(DATE_FORMAT(pd5_ocr.procedure_date,'%Y%m%d'),'00000000') WHEN pd5.sequence_number=5 AND TRIM(UPPER(bh.source)) ='ECI' THEN '' ELSE '00000000' END AS Other_Procedure_Code_Date_5 ,CASE WHEN pd6.sequence_number=6 AND LOWER(bh.trading_partner)='jopari' THEN COALESCE(DATE_FORMAT(pd6.procedure_date,'%Y%m%d'),'00000000') WHEN pd6_ocr.sequence_number=6 AND TRIM(UPPER(bh.source)) = 'KOFAX' THEN COALESCE(DATE_FORMAT(pd6_ocr.procedure_date,'%Y%m%d'),'00000000') WHEN pd6.sequence_number=6 AND TRIM(UPPER(bh.source)) ='ECI' THEN '' ELSE '00000000' END AS Other_Procedure_Code_Date_6 ,CASE WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN ('INST','H') THEN IF(TRIM(referring_record_type_physician_code) IN ('20_DN','20_71'),COALESCE(SUBSTRING(UPPER(pr.referring_provider_name),1,30),''),'') ELSE COALESCE(UPPER(TRIM(referring_provider_name)),'') END AS Referring_Provider_First_Name ,CASE WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN ('INST','H') THEN IF(TRIM(referring_record_type_physician_code) IN ('20_DN','20_71'),COALESCE(SUBSTRING(UPPER(pr.referring_provider_name),1,30),''),'') ELSE COALESCE(UPPER(TRIM(referring_provider_name)),'') END AS Referring_Provider_Middle_Name ,CASE WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN ('INST','H') THEN IF(TRIM(referring_record_type_physician_code) IN ('20_DN','20_71'),COALESCE(SUBSTRING(UPPER(pr.referring_provider_name),1,30),''),'') ELSE COALESCE(UPPER(TRIM(referring_provider_name)),'') END AS Referring_Provider_Last_Group_Name ,CASE WHEN LOWER(bh.trading_partner)='optum' THEN COALESCE(SUBSTRING(UPPER(pr.rendering_provider_dea_number),1,9),'') WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) NOT IN ('INST','H') THEN IF(UPPER(TRIM(referring_record_type_physician_code)) IN ('60_DK','20_DN'),COALESCE(SUBSTRING(UPPER(pr.referring_provider_dea_number),1,9),''),'') WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN ('INST','H') THEN IF(TRIM(referring_record_type_physician_code) IN ('20_DN','20_71'),COALESCE(SUBSTRING(UPPER(pr.referring_provider_dea_number),1,9),''),'') ELSE COALESCE(SUBSTRING(UPPER(pr.referring_provider_dea_number),1,9),'') END AS Referring_Provider_DEA_Number ,CASE WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN ('INST','H') THEN IF(TRIM(referring_record_type_physician_code) IN ('20_DN','20_71'),COALESCE(SUBSTRING(pr.referring_provider_state_license ,1,30),''),'') ELSE COALESCE(SUBSTRING(pr.referring_provider_state_license ,1,30),'') END AS Referring_Provider_License_Number ,CASE WHEN TRIM(UPPER(bh.form_type)) IN ('INST','H') AND LOWER(bh.trading_partner)='jopari' THEN COALESCE(SUBSTRING(adm.diagnosis_code ,1,8),'') WHEN TRIM(UPPER(bh.form_type)) IN ('INST','H') AND TRIM(UPPER(bh.source)) = 'KOFAX'THEN COALESCE(SUBSTRING(REPLACE(ht.Admitting_Diagnosis_Code,'.','') ,1,8),'') ELSE '' END AS Admitting_Diagnosis_Code ,COALESCE(SUBSTRING(pr.facility_npi,1,10),'') AS facility_npi ,CASE WHEN LOWER(bh.trading_partner)='optum' THEN COALESCE(SUBSTRING(pr.rendering_provider_npi,1,10),'') WHEN TRIM(UPPER(bh.form_type)) IN ('INST','H') AND LOWER(bh.trading_partner)='jopari' THEN COALESCE(SUBSTRING(pr.vendor_npi,1,10),'') WHEN TRIM(UPPER(bh.form_type)) IN ('RX','P') AND LOWER(bh.trading_partner)='jopari' THEN '' WHEN TRIM(UPPER(bh.form_type)) IN ('PROF') AND LOWER(bh.trading_partner)='jopari' THEN IF(TRIM(UPPER(pr.vendor_record_type_physician_code))='12_PAY_TO',COALESCE(SUBSTRING(pr.vendor_npi,1,10),''),COALESCE(SUBSTRING(mp.facility_npi,1,10),'')) ELSE COALESCE(SUBSTRING(IF(pr.vendor_npi=0,'',pr.vendor_npi),1,10),'') END AS Billing_Provider_NPI ,CASE WHEN TRIM(UPPER(bh.form_type)) IN ('INST','H') AND LOWER(bh.trading_partner)='jopari' THEN IF(TRIM(UPPER(pr.vendor_record_type_physician_code))='12_PAY_TO',COALESCE(SUBSTRING(pr.vendor_npi,1,10),''),COALESCE(SUBSTRING(mp.facility_npi,1,10),'')) WHEN TRIM(UPPER(bh.form_type)) IN ('INST','H') AND TRIM(UPPER(bh.source)) = 'KOFAX' THEN  COALESCE(SUBSTRING(mp.rendering_provider_npi,1,10),'') ELSE  COALESCE(SUBSTRING(mp.rendering_provider_npi,1,10),'') END AS Attending_Rendering_Provider_NPI ,CASE WHEN TRIM(UPPER(bh.form_type)) IN ('INST','H') AND LOWER(bh.trading_partner)='jopari' THEN IF(codes.revenue_code=360,COALESCE(SUBSTRING(pr.operating_provider_national_provider_id,1,10),''),'') WHEN TRIM(UPPER(bh.form_type)) IN ('PROF','RX','P') AND LOWER(bh.trading_partner)='jopari' THEN COALESCE(SUBSTRING(pr.operating_provider_national_provider_id,1,10),'') ELSE COALESCE(IF(operating_provider_national_provider_id=0,'',SUBSTRING(pr.operating_provider_national_provider_id,1,10)),'') END AS Operating_Physician_NPI ,COALESCE(REPLACE(GROUP_CONCAT(DISTINCT RPAD(SUBSTRING(COALESCE(UPPER(ext_cause.diagnosis_code),''),1,8),8,' ') ORDER BY ext_cause.sequence_number ASC),',',''),'') AS External_Cause_of_Injury_1_3 ,COALESCE(UPPER(oc1.occurance_code),'')AS Occurrence_Code_1 ,COALESCE(DATE_FORMAT(oc1.occurance_date,'%Y%m%d'),'') AS Occurrence_Date_1 ,COALESCE(UPPER(oc2.occurance_code),'') AS Occurrence_Code_2 ,COALESCE(DATE_FORMAT(oc2.occurance_date,'%Y%m%d'),'') AS Occurrence_Date_2 ,COALESCE(UPPER(oc3.occurance_code),'')AS Occurrence_Code_3 ,COALESCE(DATE_FORMAT(oc3.occurance_date,'%Y%m%d'),'')  AS Occurrence_Date_3 ,COALESCE(UPPER(oc4.occurance_code),'') AS Occurrence_Code_4 ,COALESCE(DATE_FORMAT(oc4.occurance_date,'%Y%m%d'),'') AS Occurrence_Date_4 ,CASE WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN ('INST','H') THEN IF(TRIM(referring_record_type_physician_code) IN ('20_DN','20_71'),COALESCE(SUBSTRING(pr.referring_provider_npi,1,10),''),'') ELSE COALESCE(SUBSTRING(pr.referring_provider_npi,1,10),'') END AS referring_provider_npi ,COALESCE(SUBSTRING(UPPER(pr.operating_provider_other_id),1,30),'')  AS Operating_Physician_License_Number ,CASE WHEN TRIM(UPPER(bh.source)) = 'KOFAX' THEN COALESCE(bc1_ocr.diagnosis_codes_1,'') WHEN LOWER(bh.trading_partner) IN ('align','techhealth') THEN COALESCE(bc1_AT.diagnosis_codes_1,'') ELSE COALESCE(bc1.diagnosis_codes_1,'')  END AS diagnosis_codes_1 ,CASE WHEN TRIM(UPPER(bh.form_type)) NOT IN ('INST','H') THEN COALESCE(SUBSTRING( UPPER(adm.diagnosis_code) ,1,8),'') WHEN TRIM(UPPER(bh.form_type)) IN ('INST','H') AND TRIM(UPPER(bh.source)) = 'KOFAX' THEN COALESCE(SUBSTRING( UPPER(ocr_18.diagnosis_code) ,1,8),'') ELSE SUBSTRING(COALESCE(UPPER(bc3.diagnosis_code),''),1,8) END AS Diagnosis_Code_18 ,CASE WHEN LOWER(bh.trading_partner) IN ('align','techhealth') THEN  '0000003' ELSE '' END AS MPN_HCN_Insurer_Sequence_Number ,CASE WHEN TRIM(UPPER(bh.source)) ='ECI' THEN '10' WHEN LOWER(TRIM(bh.trading_partner)) IN ('align','techhealth','optum') THEN '10' ELSE COALESCE(icd.Bill_ICD_Version,'10') END AS Bill_ICD_Version FROM txm_bitx.bill_header bh JOIN (SELECT txm_invoice_number ,status_type ,status FROM txm_bitx.invoice_status WHERE status_type='ADJUDICATION' AND status='READY_FOR_SUBMISSION' ) inv_stat ON inv_stat.txm_invoice_number=bh.txm_invoice_number LEFT OUTER JOIN codes codes ON codes.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT bill_id ,COALESCE(REPLACE(GROUP_CONCAT(RPAD(SUBSTRING(COALESCE(UPPER(diagnosis_code),''),1,8),8,' ') ORDER BY sequence_number ASC),',',''),'') AS diagnosis_code FROM (SELECT  bill_id ,sequence_number as seq ,diagnosis_code ,diagnosis_code_qualifier ,ROW_NUMBER() OVER (PARTITION BY bill_id ORDER BY sequence_number) AS sequence_number FROM txm_bitx.billing_codes WHERE TRIM(UPPER(diagnosis_code_qualifier)) IN ('BK','ABK','BF','ABF') )diag WHERE diag.sequence_number <=10 GROUP BY bill_id ) bc ON bc.bill_id=bh.bill_id LEFT OUTER JOIN(SELECT   bill_id ,COALESCE(REPLACE(GROUP_CONCAT(RPAD(SUBSTRING(COALESCE(UPPER(diagnosis_code),''),1,8),8,' ') ORDER BY sequence_number ASC),',',''),'')  AS diagnosis_code FROM (SELECT   COALESCE(REPLACE(diagnosis_code,'.',''),'') AS diagnosis_code ,bill_id ,sequence_number as seq ,ROW_NUMBER() OVER (PARTITION BY bill_id ORDER BY sequence_number) AS sequence_number FROM txm_bitx.billing_codes WHERE TRIM(UPPER(code_type))='DIAGNOSTIC' )diag WHERE diag.sequence_number <=10 GROUP BY bill_id )bc2 ON bc2.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT DISTINCT bill_id ,sequence_number ,procedure_date FROM txm_bitx.billing_codes WHERE code_type='PROCEDURE' AND sequence_number =1 AND procedure_code_qualifier IN ('BR','BBR','BQ','BBQ') ) pd1 ON pd1.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT DISTINCT bill_id ,sequence_number ,procedure_date FROM txm_bitx.billing_codes WHERE code_type='PROCEDURE' AND sequence_number =1 ) pd1_ocr ON pd1_ocr.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT DISTINCT bill_id ,sequence_number ,procedure_date FROM txm_bitx.billing_codes WHERE code_type='PROCEDURE' AND sequence_number =2 AND procedure_code_qualifier IN ('BR','BBR','BQ','BBQ') ) pd2 ON pd2.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT DISTINCT bill_id ,sequence_number ,procedure_date FROM txm_bitx.billing_codes WHERE code_type='PROCEDURE' AND sequence_number =2 ) pd2_ocr ON pd2_ocr.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT DISTINCT bill_id ,sequence_number ,procedure_date FROM txm_bitx.billing_codes WHERE code_type='PROCEDURE' AND sequence_number =3 AND procedure_code_qualifier IN ('BR','BBR','BQ','BBQ') ) pd3 ON pd3.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT DISTINCT bill_id ,sequence_number ,procedure_date FROM txm_bitx.billing_codes WHERE code_type='PROCEDURE' AND sequence_number =3 ) pd3_ocr ON pd3_ocr.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT DISTINCT bill_id ,sequence_number ,procedure_date FROM txm_bitx.billing_codes WHERE code_type='PROCEDURE' AND sequence_number =4 AND procedure_code_qualifier IN ('BR','BBR','BQ','BBQ') ) pd4 ON pd4.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT DISTINCT bill_id ,sequence_number ,procedure_date FROM txm_bitx.billing_codes WHERE code_type='PROCEDURE' AND sequence_number =4 ) pd4_ocr ON pd4_ocr.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT DISTINCT bill_id ,sequence_number ,procedure_date FROM txm_bitx.billing_codes WHERE code_type='PROCEDURE' AND sequence_number =5 AND procedure_code_qualifier IN ('BR','BBR','BQ','BBQ') ) pd5 ON pd5.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT DISTINCT bill_id ,sequence_number ,procedure_date FROM txm_bitx.billing_codes WHERE code_type='PROCEDURE' AND sequence_number =5 ) pd5_ocr ON pd5_ocr.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT DISTINCT bill_id ,sequence_number ,procedure_date FROM txm_bitx.billing_codes WHERE code_type='PROCEDURE' AND sequence_number =6 AND procedure_code_qualifier IN ('BR','BBR','BQ','BBQ') ) pd6 ON pd6.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT DISTINCT bill_id ,sequence_number ,procedure_date FROM txm_bitx.billing_codes WHERE code_type='PROCEDURE' AND sequence_number =6 ) pd6_ocr ON pd6_ocr.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT DISTINCT bill_id ,sequence_number ,occurance_code ,occurance_date FROM txm_bitx.billing_codes WHERE TRIM(UPPER(code_type)) ='OCCURANCE' AND sequence_number =1 ) oc1 ON oc1.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT DISTINCT bill_id ,sequence_number ,occurance_code ,occurance_date FROM txm_bitx.billing_codes WHERE TRIM(UPPER(code_type)) ='OCCURANCE' AND sequence_number =2 ) oc2 ON oc2.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT DISTINCT bill_id ,sequence_number ,occurance_code ,occurance_date FROM txm_bitx.billing_codes WHERE TRIM(UPPER(code_type)) ='OCCURANCE' AND sequence_number =3 ) oc3 ON oc3.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT DISTINCT bill_id ,sequence_number ,occurance_code ,occurance_date FROM txm_bitx.billing_codes WHERE TRIM(UPPER(code_type)) ='OCCURANCE' AND sequence_number =4 ) oc4 ON oc4.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT bill_id ,COALESCE(REPLACE(GROUP_CONCAT(RPAD(SUBSTRING(COALESCE(UPPER(diagnosis_code),''),1,8),8,' ') ORDER BY sequence_number ASC),',',''),'') AS diagnosis_codes_1 FROM (SELECT bill_id ,REPLACE(diagnosis_code,'.','') AS diagnosis_code ,sequence_number FROM (SELECT  bill_id ,sequence_number as seq ,REPLACE(diagnosis_code,'.','') AS diagnosis_code ,diagnosis_code_qualifier ,ROW_NUMBER() OVER (PARTITION BY bill_id ORDER BY sequence_number) AS sequence_number FROM txm_bitx.billing_codes WHERE TRIM(UPPER(diagnosis_code_qualifier)) IN ('BK','ABK','BF','ABF') )diag WHERE diag.sequence_number BETWEEN 11 AND 17)AA GROUP BY bill_id ) bc1 ON bc1.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT bill_id ,COALESCE(REPLACE(GROUP_CONCAT(RPAD(SUBSTRING(COALESCE(UPPER(diagnosis_code),''),1,8),8,' ') ORDER BY sequence_number ASC),',',''),'') AS diagnosis_codes_1 FROM (SELECT bill_id ,diagnosis_code ,sequence_number FROM (SELECT  bill_id ,sequence_number as seq ,REPLACE(diagnosis_code,'.','') AS  diagnosis_code ,diagnosis_code_qualifier ,ROW_NUMBER() OVER (PARTITION BY bill_id ORDER BY sequence_number) AS sequence_number FROM txm_bitx.billing_codes WHERE TRIM(UPPER(code_type)) ='DIAGNOSTIC' )diag WHERE diag.sequence_number BETWEEN 11 AND 17) QQQ GROUP BY bill_id ) bc1_AT ON bc1_AT.bill_id=bh.bill_id LEFT OUTER JOIN ( SELECT bill_id ,COALESCE(REPLACE(GROUP_CONCAT(RPAD(SUBSTRING(COALESCE(UPPER(diagnosis_code),''),1,8),8,' ') ORDER BY sequence_number ASC),',',''),'') AS diagnosis_codes_1 FROM (SELECT bill_id ,diagnosis_code ,sequence_number FROM (SELECT  bill_id ,sequence_number as seq ,REPLACE(diagnosis_code,'.','') AS diagnosis_code ,diagnosis_code_qualifier ,ROW_NUMBER() OVER (PARTITION BY bill_id ORDER BY sequence_number) AS sequence_number FROM txm_bitx.billing_codes WHERE TRIM(UPPER(code_type))='DIAGNOSTIC' )diag WHERE diag.sequence_number BETWEEN 11 AND 17)A GROUP BY bill_id ) bc1_ocr ON bc1_ocr.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT bill_id ,diagnosis_code ,sequence_number FROM (SELECT  bill_id ,sequence_number as seq ,REPLACE(diagnosis_code,'.','') AS diagnosis_code ,diagnosis_code_qualifier ,ROW_NUMBER() OVER (PARTITION BY bill_id ORDER BY sequence_number) AS sequence_number FROM txm_bitx.billing_codes WHERE TRIM(UPPER(diagnosis_code_qualifier)) IN ('BK','ABK','BF','ABF') )diag WHERE diag.sequence_number =18 ) bc3 ON bc3.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT bill_id ,diagnosis_code ,sequence_number FROM (SELECT  bill_id ,sequence_number as seq ,REPLACE(diagnosis_code,'.','') AS diagnosis_code ,diagnosis_code_qualifier ,ROW_NUMBER() OVER (PARTITION BY bill_id ORDER BY sequence_number) AS sequence_number FROM txm_bitx.billing_codes WHERE TRIM(UPPER(code_type))='DIAGNOSTIC' )diag WHERE diag.sequence_number =18 ) ocr_18 ON ocr_18.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT DISTINCT  bill_id ,external_cause_of_injury ,external_cause_of_injury_2 ,external_cause_of_injury_3 ,patient_discharge_status ,pps_code ,admission_source ,admission_type ,admission_hour ,admission_date ,discharge_hour ,thru_service_bill_date ,hospitalization_treatment_id ,from_service_bill_date ,Admitting_Diagnosis_Code ,type_of_bill FROM txm_bitx.hospitalization_treatment ) ht ON ht.bill_id=bh.bill_id LEFT OUTER JOIN txm_bitx.patient  p ON p.bill_id=bh.bill_id LEFT OUTER JOIN txm_bitx.billing_documents bdo ON bdo.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT * FROM (SELECT signing_provider_date, provider_id, bill_id, rendering_provider_nabp, rendering_provider_dea_number, referring_provider_dea_number, rendering_provider_taxonomy_code, referring_provider_name, referring_provider_address_1, referring_provider_address_2, referring_provider_city, referring_provider_state, referring_provider_zip_code, rendering_provider_npi, rendering_provider_date, rendering_provider_license, facility_name, facility_address_1, facility_address_2, facility_city, facility_state, facility_zip_code, facility_npi, facility_other_id, facility_tax_id, vendor_name, vendor_address_1, vendor_address_2, vendor_city, vendor_state, vendor_country, vendor_zip_code, vendor_phone_number, vendor_npi, vendor_other_id, rendering_physician_name, rendering_physician_npi, rendering_provider_name, vendor_tax_id, pay_to_provider_state_license, pay_to_provider_NPI, vendor_number, vendor_dba, vendor_legalname, referring_provider_other_id, referring_provider_state_license, referring_provider_npi, additional_name, operating_provider_first_name, operating_provider_last_name, operating_provider_national_provider_id, operating_provider_other_id, attending_provider_first_name, attending_provider_last_name, attending_provider_national_provider_id, attending_provider_other_id, provider_number, federal_military_treatment_facility, rendering_provider_other_id, vendor_record_type_physician_code, referring_record_type_physician_code, ROW_NUMBER() OVER(PARTITION BY bill_id ORDER BY provider_id) AS rw FROM txm_bitx.provider ) provider ) pr ON pr.bill_id=bh.bill_id LEFT OUTER JOIN txm_bitx.professional_treatment pt ON pt.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT bill_id ,COALESCE(DATE_FORMAT(bill_calculation_date,'%Y%m%d'),'') AS bill_calculation_date ,SUM(cost_amount) as cost_amount ,SUM(tax_amount) as tax_amount FROM txm_bitx.pharmacy_line GROUP BY bill_id,bill_calculation_date) pl ON pl.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT bill_id,procedure_code,place_of_service_code,treatment_id,treatment_line_id FROM (SELECT DISTINCT  bill_id ,procedure_code ,place_of_service_code ,treatment_id ,treatment_line_id ,ROW_NUMBER () OVER (PARTITION BY bill_id,treatment_id  ORDER BY treatment_line_id) AS rw FROM txm_bitx.professional_treatment_line )q WHERE rw <=6 ) ptl ON ptl.treatment_id=pt.treatment_id LEFT OUTER JOIN (SELECT  bill_id ,treatment_id ,COALESCE(SUBSTRING(LPAD(CAST(SUM(line_item_fee_amount)*100 AS SIGNED),9,0),1,9),'') as Retail_PPO_Fees FROM txm_bitx.professional_treatment_line GROUP BY 1,2 ) ptl_ppo ON ptl_ppo.treatment_id=pt.treatment_id LEFT OUTER JOIN (SELECT DISTINCT bill_id ,diagnosis_code FROM txm_bitx.billing_codes WHERE TRIM(UPPER(diagnosis_code_qualifier)) IN ('BJ','ABJ') ) adm ON adm.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT  treatment_id ,service_date_from ,service_date_to FROM (SELECT  treatment_id ,service_date_from ,service_date_to ,ROW_NUMBER() OVER (PARTITION BY treatment_id ORDER BY treatment_id ASC) AS rw FROM txm_bitx.professional_treatment_line )q WHERE q.rw=1 )kptl ON kptl.treatment_id=pt.treatment_id LEFT OUTER JOIN ( SELECT COALESCE(REPLACE(GROUP_CONCAT(RPAD(SUBSTRING(COALESCE(UPPER(procedure_code),''),1,8),8,' ') ORDER BY sequence_number ASC),',',''),'') AS ICD_Procedure_Code, bill_id FROM (SELECT DISTINCT bill_id ,procedure_code ,sequence_number FROM  txm_bitx.billing_codes WHERE code_type='PROCEDURE' AND sequence_number <=6 AND procedure_code_qualifier IN ('BR','BBR','BQ','BBQ') )q GROUP BY bill_id)icd_codes ON icd_codes.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT COALESCE(REPLACE(GROUP_CONCAT(RPAD(SUBSTRING(COALESCE(UPPER(procedure_code),''),1,8),8,' ') ORDER BY sequence_number ASC),',',''),'') AS ICD_Procedure_Code, bill_id FROM (SELECT DISTINCT bill_id ,procedure_code ,sequence_number FROM  txm_bitx.billing_codes WHERE code_type='PROCEDURE' AND sequence_number <=6 )qq GROUP BY bill_id )icd_codes_ocr ON icd_codes_ocr.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT DISTINCT bill_id ,Bill_ICD_Version FROM (SELECT  bill_id ,COALESCE(Right(diagnosis_code_qualifier_icd,2),NULLIF(RIGHT(diagnosis_code_qualifier,2),''),'10') as Bill_ICD_Version ,ROW_NUMBER() OVER (PARTITION BY bill_id ORDER BY sequence_number) AS rw  FROM txm_bitx.billing_codes WHERE code_type='DIAGNOSTIC' )q WHERE q.rw=1 ) icd ON icd.bill_id=bh.bill_id LEFT OUTER JOIN(SELECT * FROM( SELECT bill_id ,diagnosis_code ,ROW_NUMBER() OVER(PARTITION BY bill_id ORDER BY sequence_number) as sequence_number FROM  txm_bitx.billing_codes WHERE code_type='DIAGNOSTIC' AND TRIM(UPPER(diagnosis_code_qualifier)) IN ('BN','ABN') )e WHERE e.sequence_number <=3 )ext_cause ON ext_cause.bill_id=bh.bill_id LEFT OUTER JOIN txm_bitx_provider.provider mp ON mp.provider_number=pr.provider_number LEFT OUTER JOIN(SELECT  bill_id ,MIN(service_from_date) AS admit_date ,MAX(service_thru_date) AS discharge_date FROM txm_bitx.pharmacy_line GROUP By 1 ) dates_rx ON dates_rx.bill_id=bh.bill_id WHERE bh.file_header_id IS NOT NULL AND bh.txm_invoice_number IS NOT NULL GROUP BY bh.bill_id","db_read_sql_select_detail":"SELECT trading_partner, bill_id, form_type, COALESCE(referring_record_type_physician_code,'') AS referring_record_type_physician_code, treatment_id, source, Charge_L, Legacy_Diagnosis_Reference_1, Legacy_Diagnosis_Reference_2, Legacy_Diagnosis_Reference_3, Legacy_Diagnosis_Reference_4, DOS, filler, Import_Bill_ID, COALESCE(ModifierMessage_Code_1,'') as ModifierMessage_Code_1, COALESCE(ModifierMessage_Code_2,'') AS ModifierMessage_Code_2, COALESCE(ModifierMessage_Code_3,'') AS ModifierMessage_Code_3, COALESCE(ModifierMessage_Code_4,'') AS ModifierMessage_Code_4, COALESCE(ModifierMessage_Code_5,'') AS ModifierMessage_Code_5, POS_L, CASE WHEN LOWER(trading_partner) IN ('align','techhealth') THEN COALESCE(CONCAT( CASE WHEN TRIM(Procedure_Code) <> '' AND Procedure_Code IS NOT NULL THEN Procedure_Code ELSE '' END, CASE WHEN TRIM(Procedure_Code) <> '' AND Procedure_Code IS NOT NULL AND TRIM(ModifierMessage_Code_2) <> ''  AND TRIM(ModifierMessage_Code_2) IS NOT NULL THEN '-' ELSE '' END, CASE WHEN TRIM(ModifierMessage_Code_2) <> ''  AND TRIM(ModifierMessage_Code_2) IS NOT NULL THEN TRIM(ModifierMessage_Code_2) ELSE '' END, CASE WHEN TRIM(ModifierMessage_Code_2) <> ''  AND TRIM(ModifierMessage_Code_2) IS NOT NULL AND TRIM(ModifierMessage_Code_3) <> ''  AND TRIM(ModifierMessage_Code_3) IS NOT NULL THEN '-' ELSE '' END, CASE WHEN TRIM(ModifierMessage_Code_3) <> ''  AND TRIM(ModifierMessage_Code_3) IS NOT NULL THEN TRIM(ModifierMessage_Code_3) ELSE '' END, CASE WHEN TRIM(ModifierMessage_Code_3) <> '' AND TRIM(ModifierMessage_Code_3) IS NOT NULL AND TRIM(ModifierMessage_Code_4) <> ''  AND TRIM(ModifierMessage_Code_4) IS NOT NULL THEN '-' ELSE '' END, CASE WHEN TRIM(ModifierMessage_Code_4) <> '' AND TRIM(ModifierMessage_Code_4) IS NOT NULL THEN TRIM(ModifierMessage_Code_4) ELSE '' END, CASE WHEN TRIM(ModifierMessage_Code_4) <> '' AND TRIM(ModifierMessage_Code_4) IS NOT NULL AND TRIM(ModifierMessage_Code_5) <> ''  AND TRIM(ModifierMessage_Code_5) IS NOT NULL THEN '-' ELSE '' END, CASE WHEN TRIM(ModifierMessage_Code_5) <> '' AND TRIM(ModifierMessage_Code_5) IS NOT NULL THEN TRIM(ModifierMessage_Code_5) ELSE '' END ),'') ELSE ''  END AS Procedure_Code_Billed, Procedure_Code, Proc_Type, Revenue_Code, CASE WHEN Days_Supply IS NOT NULL AND TRIM(Days_Supply) <> '' THEN LPAD(Days_Supply,3,0) ELSE '' END AS Days_Supply, Rx_Number, CASE WHEN ppo_reductions=000000000 THEN '' ELSE ppo_reductions END AS ppo_reductions, Units, Rendering_Provider_Secondary_Identifier, Certification_DAW, Message_Code_Modifier_Jurisdiction_1, Message_Reduction_Code_1, Rendering_Provider_NPI, CASE WHEN TRIM(Rendering_Provider_Secondary_Identifier) IS NOT NULL AND TRIM(Rendering_Provider_Secondary_Identifier) <> '' THEN '0B' ELSE '' END  Qualifier, COALESCE(pharmacy_line_number,hospitalization_line_number,professional_line_number,1) AS line_seq FROM (WITH freq AS ( SELECT bill_id,txm_invoice_number,cast(concat(facility_code,bill_frequency_type_code) AS signed) as EIBLTP FROM  txm_bitx.bill_header WHERE txm_invoice_number IN ( SELECT txm_invoice_number FROM txm_bitx.invoice_status WHERE status_type='ADJUDICATION' AND status='READY_FOR_SUBMISSION' ) AND txm_invoice_number IS NOT NULL AND file_header_id IS NOT NULL ) SELECT bh.trading_partner ,bh.bill_id ,bh.form_type ,pt.treatment_id ,bh.source ,referring_record_type_physician_code ,CASE WHEN LOWER(bh.trading_partner) IN ('jopari','align','techhealth') AND TRIM(UPPER(bh.form_type))IN ('PROF' ,'HCFA') THEN COALESCE(SUBSTRING(LPAD(CAST(ptl.charges_for_services*100 AS SIGNED),9,0),1,9),'') WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN('INST','H') THEN COALESCE(SUBSTRING(LPAD(CAST(htl.charge_for_service*100 AS SIGNED),9,0),1,9),'') WHEN LOWER(bh.source)='kofax' AND TRIM(UPPER(bh.form_type)) IN ('PROF' ,'HCFA') THEN COALESCE(SUBSTRING(LPAD(CAST(ptl.charges_for_services*100 AS SIGNED),9,0),1,9),'') WHEN LOWER(bh.source)='kofax' AND TRIM(UPPER(bh.form_type)) IN('INST','H') THEN COALESCE(SUBSTRING(LPAD(CAST(htl.total_charge*100 AS SIGNED),9,0),1,9),'') WHEN TRIM(UPPER(bh.form_type)) IN('RX','P') AND LOWER(bh.trading_partner)='jopari' THEN COALESCE(SUBSTRING(LPAD(CAST(pl.total_charge_per_bill*100 AS SIGNED),9,0),1,9),'') WHEN TRIM(UPPER(bh.form_type)) IN('RX','P') AND LOWER(bh.source)='kofax' THEN COALESCE(SUBSTRING(LPAD(CAST(pl.total_charge_per_bill*100 AS SIGNED),9,0),1,9),'') WHEN LOWER(bh.trading_partner) ='optum' THEN COALESCE(SUBSTRING(LPAD(CAST(pl.charged_amount*100 AS SIGNED),9,0),1,9),'')  ELSE '' END AS Charge_L ,CASE WHEN LOWER(bh.trading_partner) IN ('align','techhealth','jopari') AND TRIM(UPPER(bh.form_type)) IN ('PROF' ,'HCFA') THEN COALESCE(SUBSTRING(ptl.diagnosis_pointer_1,1,1),'') WHEN LOWER(bh.trading_partner) IN ('jopari') AND TRIM(UPPER(bh.form_type)) IN ('RX','P') THEN COALESCE(SUBSTRING(pl.diagnosis_pointer_1,1,1),'') WHEN LOWER(bh.source)='kofax' AND TRIM(UPPER(bh.form_type)) IN ('PROF' ,'HCFA') THEN COALESCE(SUBSTRING(ptl.diagnosis_pointer_1,1,1),'') ELSE '' END AS Legacy_Diagnosis_Reference_1 ,CASE WHEN LOWER(bh.trading_partner) IN ('align','techhealth','jopari') AND TRIM(UPPER(bh.form_type))IN ('PROF' ,'HCFA') THEN COALESCE(SUBSTRING(ptl.diagnosis_pointer_2,1,1),'') WHEN LOWER(bh.trading_partner) IN ('jopari') AND TRIM(UPPER(bh.form_type)) IN ('RX','P') THEN COALESCE(SUBSTRING(pl.diagnosis_pointer_2,1,1),'') WHEN LOWER(bh.source)='kofax' AND TRIM(UPPER(bh.form_type)) IN ('PROF' ,'HCFA','RX','P') THEN COALESCE(SUBSTRING(ptl.diagnosis_pointer_2,1,1),'') ELSE '' END AS Legacy_Diagnosis_Reference_2 ,CASE WHEN LOWER(bh.trading_partner) IN ('align','techhealth','jopari') AND TRIM(UPPER(bh.form_type))IN ('PROF' ,'HCFA') THEN COALESCE(SUBSTRING(ptl.diagnosis_pointer_3,1,1),'') WHEN LOWER(bh.trading_partner) IN ('jopari') AND TRIM(UPPER(bh.form_type)) IN ('RX','P') THEN COALESCE(SUBSTRING(pl.diagnosis_pointer_3,1,1),'') WHEN LOWER(bh.source)='kofax' AND TRIM(UPPER(bh.form_type)) IN ('PROF' ,'HCFA') THEN COALESCE(SUBSTRING(ptl.diagnosis_pointer_3,1,1),'') ELSE '' END AS Legacy_Diagnosis_Reference_3 ,CASE WHEN LOWER(bh.trading_partner) IN ('align','techhealth','jopari') AND TRIM(UPPER(bh.form_type))IN ('PROF' ,'HCFA') THEN COALESCE(SUBSTRING(ptl.diagnosis_pointer_4,1,1),'') WHEN LOWER(bh.trading_partner) IN ('jopari') AND TRIM(UPPER(bh.form_type)) IN ('RX','P') THEN COALESCE(SUBSTRING(pl.diagnosis_pointer_4,1,1),'') WHEN LOWER(bh.source)='kofax' AND TRIM(UPPER(bh.form_type))= 'PROF' THEN COALESCE(SUBSTRING(ptl.diagnosis_pointer_4,1,1),'') ELSE '' END AS Legacy_Diagnosis_Reference_4 ,CASE WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type))IN ('PROF' ,'HCFA') THEN COALESCE(DATE_FORMAT(ptl.service_date_from,'%Y%m%d'),'') WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN('INST','H') THEN COALESCE(DATE_FORMAT(htl.service_from_date,'%Y%m%d'),'') WHEN LOWER(bh.trading_partner) IN ('align','techhealth') THEN COALESCE(DATE_FORMAT(ptl.service_date_from,'%Y%m%d'),'') WHEN LOWER(bh.source)='kofax' AND TRIM(UPPER(bh.form_type))= 'PROF' THEN COALESCE(DATE_FORMAT(ptl.service_date_from,'%Y%m%d'),'') WHEN LOWER(bh.source)='kofax' AND TRIM(UPPER(bh.form_type))= 'INST' THEN COALESCE(DATE_FORMAT(htl.service_from_date,'%Y%m%d'),'') WHEN TRIM(UPPER(bh.form_type)) IN ('RX','P') AND LOWER(bh.trading_partner)='jopari' THEN COALESCE(DATE_FORMAT(pl.service_from_date ,'%Y%m%d'),'') WHEN TRIM(UPPER(bh.form_type)) IN ('RX','P') AND LOWER(bh.trading_partner)='optum' THEN COALESCE(DATE_FORMAT(pl.service_from_date ,'%Y%m%d'),'') WHEN TRIM(UPPER(bh.form_type)) IN ('RX','P') AND LOWER(bh.source)='kofax' THEN COALESCE(DATE_FORMAT(pl.service_from_date ,'%Y%m%d'),'') ELSE '' END AS DOS ,CASE WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type))IN ('PROF' ,'HCFA') THEN COALESCE(DATE_FORMAT(ptl.service_date_to,'%Y%m%d'),'') WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN('INST','H') THEN COALESCE(DATE_FORMAT(htl.service_thru_date,'%Y%m%d'),'') WHEN LOWER(bh.trading_partner) IN ('align','techhealth') THEN COALESCE(DATE_FORMAT(ptl.service_date_to,'%Y%m%d'),'') WHEN  TRIM(UPPER(bh.form_type)) IN ('RX','P') AND LOWER(bh.trading_partner)='jopari' THEN COALESCE(DATE_FORMAT(pl.service_thru_date ,'%Y%m%d'),'') WHEN  TRIM(UPPER(bh.form_type)) IN ('RX','P') AND LOWER(bh.trading_partner)='optum' THEN COALESCE(DATE_FORMAT(pl.service_thru_date ,'%Y%m%d'),'') WHEN LOWER(bh.source)='kofax' AND TRIM(UPPER(bh.form_type))= 'PROF' THEN COALESCE(DATE_FORMAT(ptl.service_date_to,'%Y%m%d'),'') WHEN LOWER(bh.source)='kofax' AND TRIM(UPPER(bh.form_type))= 'INST' THEN COALESCE(DATE_FORMAT(ht.thru_service_bill_date,'%Y%m%d'),'') WHEN TRIM(UPPER(bh.form_type)) IN ('RX','P') AND LOWER(bh.source)='kofax' THEN COALESCE(DATE_FORMAT(pl.service_thru_date ,'%Y%m%d'),'') ELSE '' END AS filler ,COALESCE(SUBSTRING(CAST(bh.txm_invoice_number AS CHAR(50)),1,50),'')  AS Import_Bill_ID ,CASE WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN ('P','RX') THEN COALESCE(SUBSTRING(bh.explanation_of_benefits,1,6),'') WHEN TRIM(UPPER(bh.form_type)) IN ('INST','H') THEN COALESCE(SUBSTRING(hcpcs_modifier_code_1,1,2),'') WHEN LOWER(bh.trading_partner)='optum'  THEN 'PC4' WHEN LOWER(bh.trading_partner) IN ('align','techhealth') THEN 729 WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type))IN ('PROF' ,'HCFA') AND ptl.procedure_code IN (97545,97546) THEN CASE WHEN (TRIM(ptl.procedure_code_modifier_1)='CA' AND TRIM(ptl.procedure_code_modifier_2) IN ('WC','WH')) THEN COALESCE(SUBSTRING(ptl.procedure_code_modifier_2,1,6),'') WHEN TRIM(ptl.procedure_code_modifier_1)='' THEN COALESCE(SUBSTRING(ptl.procedure_code_modifier_2,1,6),'') WHEN TRIM(ptl.procedure_code_modifier_1)='59' AND TRIM(ptl.procedure_code_modifier_2)='SG' THEN COALESCE(SUBSTRING(ptl.procedure_code_modifier_2,1,6),'') ELSE COALESCE(SUBSTRING(ptl.procedure_code_modifier_1,1,6),'') END ELSE COALESCE(SUBSTRING(ptl.procedure_code_modifier_1,1,6),'') END AS ModifierMessage_Code_1 ,CASE WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN ('P','RX')  THEN '' WHEN TRIM(UPPER(bh.form_type)) IN ('INST','H') THEN COALESCE(SUBSTRING(hcpcs_modifier_code_2,1,2),'') WHEN LOWER(bh.trading_partner)='optum'  THEN '' WHEN LOWER(bh.trading_partner) IN ('align','techhealth') THEN COALESCE(SUBSTRING(ptl.procedure_code_modifier_1,1,2),'') WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN ('PROF' ,'HCFA')AND ptl.procedure_code IN (97545,97546) THEN CASE   WHEN (TRIM(ptl.procedure_code_modifier_1)='CA' AND TRIM(ptl.procedure_code_modifier_2) IN ('WC','WH')) THEN COALESCE(SUBSTRING(ptl.procedure_code_modifier_1,1,6),'') WHEN TRIM(ptl.procedure_code_modifier_1)='' THEN COALESCE(SUBSTRING(ptl.procedure_code_modifier_3,1,6),'') WHEN TRIM(ptl.procedure_code_modifier_1)='59' AND TRIM(ptl.procedure_code_modifier_2)='SG' THEN COALESCE(SUBSTRING(ptl.procedure_code_modifier_1,1,6),'') WHEN TRIM(ptl.procedure_code_modifier_2)=''  THEN COALESCE(SUBSTRING(ptl.procedure_code_modifier_3,1,6),'') ELSE COALESCE(SUBSTRING(ptl.procedure_code_modifier_2,1,6),'') END ELSE COALESCE(SUBSTRING(ptl.procedure_code_modifier_2,1,6),'') END AS ModifierMessage_Code_2 ,CASE WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN ('P','RX')  THEN '' WHEN TRIM(UPPER(bh.form_type)) IN ('INST','H') THEN COALESCE(SUBSTRING(hcpcs_modifier_code_3,1,2),'') WHEN LOWER(bh.trading_partner)='optum'  THEN '' WHEN LOWER(bh.trading_partner) IN ('align','techhealth') THEN COALESCE(SUBSTRING(ptl.procedure_code_modifier_2,1,2),'') WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type))IN ('PROF' ,'HCFA') AND ptl.procedure_code IN (97545,97546) THEN CASE WHEN TRIM(ptl.procedure_code_modifier_1)=''  THEN '' WHEN TRIM(ptl.procedure_code_modifier_2)=''  THEN '' ELSE '' END ELSE COALESCE(SUBSTRING(ptl.procedure_code_modifier_3,1,6),'') END AS ModifierMessage_Code_3 ,CASE WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN ('P','RX')  THEN '' WHEN LOWER(bh.trading_partner)='optum'  THEN '' WHEN LOWER(bh.trading_partner) IN ('align','techhealth') THEN COALESCE(SUBSTRING(ptl.procedure_code_modifier_2,1,2),'') WHEN TRIM(UPPER(bh.form_type)) IN ('INST','H')  THEN COALESCE(SUBSTRING(hcpcs_modifier_code_4,1,2),'') ELSE COALESCE(SUBSTRING(ptl.procedure_code_modifier_4,1,6),'') END AS ModifierMessage_Code_4 ,CASE WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN ('P','RX')  THEN '' WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN ('PROF' ,'HCFA')  THEN '' WHEN LOWER(bh.trading_partner)='optum'  THEN '' WHEN LOWER(bh.trading_partner) IN ('align','techhealth') THEN COALESCE(SUBSTRING(ptl.procedure_code_modifier_3,1,2),'') WHEN LOWER(bh.source)='kofax' THEN '' ELSE COALESCE(SUBSTRING(ptl.procedure_code_modifier_4,1,6),'') END AS ModifierMessage_Code_5 ,CASE WHEN TRIM(UPPER(bh.form_type)) IN ('PROF' ,'HCFA')   THEN  COALESCE(SUBSTRING(ptl.place_of_service_code,1,3),'') WHEN LOWER(bh.source)='kofax' AND TRIM(UPPER(bh.form_type)) IN ('PROF' ,'HCFA') THEN  COALESCE(SUBSTRING(ptl.place_of_service_code,1,3),'') WHEN TRIM(UPPER(bh.form_type)) IN ('H','INST') THEN CASE WHEN ((EIBLTP >= 110 and EIBLTP <= 129) OR (EIBLTP >= 150 and EIBLTP <= 189) OR (EIBLTP >= 210 and EIBLTP <= 229) OR (EIBLTP >= 250 and EIBLTP <= 289) OR (EIBLTP >= 350 and EIBLTP <= 389) OR (EIBLTP >= 410 and EIBLTP <= 429) OR (EIBLTP >= 450 and EIBLTP <= 489) OR (EIBLTP >= 510 and EIBLTP <= 529) OR (EIBLTP >= 550 and EIBLTP <= 589) OR (EIBLTP >= 610 and EIBLTP <= 629) OR (EIBLTP >= 650 and EIBLTP <= 689) OR (EIBLTP >= 810 and EIBLTP <= 829)) THEN 21 WHEN  (EIBLTP >= 230 and EIBLTP <= 239)  THEN 31 WHEN  (EIBLTP >= 850 and EIBLTP <= 859)  THEN 22 WHEN  (EIBLTP >= 330 and EIBLTP <= 339)  THEN 12 WHEN  EIBLTP >= 320 AND EIBLTP <= 349 THEN 12 ELSE 22 END WHEN TRIM(UPPER(bh.form_type)) IN ('RX' ,'P') THEN '01' ELSE '' END AS POS_L ,'' AS Procedure_Code_Billed ,CASE WHEN TRIM(UPPER(bh.form_type)) IN ('INST','H') THEN IF(TRIM(htl.procedure_code) IS NOT NULL AND TRIM(htl.procedure_code) <> '',COALESCE(SUBSTRING(htl.procedure_code,1,30),''),COALESCE(SUBSTRING(htl.revenue_code,1,30),'')) WHEN TRIM(UPPER(bh.form_type)) IN ('P','RX') THEN COALESCE(IF(SUBSTRING(TRIM(pl.NDC_code),1,30) IS NOT NULL AND SUBSTRING(TRIM(pl.NDC_code),1,30) <> '',COALESCE(SUBSTRING(TRIM(pl.NDC_code),1,30),''),COALESCE(SUBSTRING(TRIM(pl.name_brand_ndc),1,30),'')),'') ELSE COALESCE(SUBSTRING(ptl.procedure_code,1,30),'') END AS Procedure_Code ,CASE  WHEN  TRIM(UPPER(bh.form_type)) IN ('INST','H') THEN IF(TRIM(htl.procedure_code) IS NOT NULL AND  TRIM(htl.procedure_code) <> '','P','R') WHEN  TRIM(UPPER(bh.form_type)) IN ('RX','P') THEN 'N' WHEN  TRIM(UPPER(bh.source)) ='ECI' THEN '' ELSE 'P' END AS   Proc_Type ,CASE  WHEN  TRIM(UPPER(bh.form_type)) IN ('INST','H') AND TRIM(htl.procedure_code) IS NOT NULL AND  TRIM(htl.procedure_code) <>  '' THEN  COALESCE(SUBSTRING(htl.revenue_code,1,4),'')  ELSE '' END AS  Revenue_Code ,CASE WHEN TRIM(UPPER(bh.form_type))IN ('RX','P') THEN  COALESCE(SUBSTRING(pl.days_supply,1,3),'') ELSE '' END AS Days_Supply ,CASE WHEN TRIM(UPPER(bh.form_type))IN ('RX','P') THEN  COALESCE(SUBSTRING(pl.prescription_number,1,20),'') ELSE '' END AS Rx_Number ,CASE WHEN LOWER(bh.trading_partner) IN ('align','techhealth') THEN COALESCE(SUBSTRING(LPAD(CAST((ptl.ppo_reductions) *100 AS SIGNED),9,0),1,9),'') WHEN LOWER(bh.trading_partner)='jopari' AND TRIM(UPPER(bh.form_type)) IN('INST','H') THEN COALESCE(SUBSTRING(LPAD(CAST(htl.charge_for_service*100 AS SIGNED),9,0),1,9),'') WHEN LOWER(bh.trading_partner) ='jopari' AND TRIM(UPPER(bh.form_type)) IN ('PROF') THEN COALESCE(SUBSTRING(LPAD(CAST(ptl.charges_for_services*100 AS SIGNED),9,0),1,9),'') WHEN TRIM(UPPER(bh.form_type)) IN ('RX','P')  AND LOWER(bh.trading_partner) ='jopari' THEN COALESCE(SUBSTRING(LPAD(CAST(pl.total_charge_per_bill*100 AS SIGNED),9,0),1,9),'') WHEN TRIM(UPPER(bh.form_type)) IN ('RX','P')  AND LOWER(bh.trading_partner) ='optum' THEN COALESCE(SUBSTRING(LPAD(CAST((charged_amount-contract_amount+ tax_amount)*100 AS SIGNED),9,0),1,9),'') WHEN LOWER(bh.source) ='kofax' AND TRIM(UPPER(bh.form_type)) IN ('PROF' ,'HCFA') THEN COALESCE(SUBSTRING(LPAD(CAST(ptl.charges_for_services*100 AS SIGNED),9,0),1,9),'') WHEN LOWER(bh.source)='kofax' AND TRIM(UPPER(bh.form_type)) IN('INST','H') THEN COALESCE(SUBSTRING(LPAD(CAST(htl.total_charge*100 AS SIGNED),9,0),1,9),'') WHEN TRIM(UPPER(bh.form_type)) IN('RX','P') AND LOWER(bh.source)='kofax' THEN COALESCE(SUBSTRING(LPAD(CAST(pl.total_charge_per_bill*100 AS SIGNED),9,0),1,9),'') ELSE '' END AS ppo_reductions ,CASE WHEN TRIM(UPPER(bh.form_type)) IN ('PROF' ,'HCFA') THEN  COALESCE(SUBSTRING(CAST(ptl.units AS SIGNED),1,4),'') WHEN TRIM(UPPER(bh.form_type)) IN('INST','H') THEN COALESCE(SUBSTRING(CAST(htl.units_of_service AS SIGNED),1,4),'') WHEN TRIM(UPPER(bh.form_type)) IN ('RX','P') THEN COALESCE(SUBSTRING( pl.quantity,1,4),'') ELSE'' END AS Units ,CASE WHEN LOWER(bh.trading_partner) = 'optum' THEN '' WHEN LOWER(bh.trading_partner) = 'jopari' AND TRIM(UPPER(bh.form_type)) NOT IN('RX','P') THEN  IF(TRIM(pr.rendering_record_type_physician_code)='60_82',COALESCE(SUBSTRING(mp.rendering_provider_license,1,30),''),'') WHEN LOWER(bh.trading_partner) = 'jopari' AND TRIM(UPPER(bh.form_type)) IN('RX','P') THEN '' WHEN LOWER(bh.source)='kofax' AND TRIM(UPPER(bh.form_type)) IN('RX','P','INST') THEN  '' WHEN LOWER(bh.source)='kofax' AND TRIM(UPPER(bh.form_type)) IN('PROF') THEN  COALESCE(SUBSTRING(rendering_provider_other_id,1,30),'') ELSE COALESCE(SUBSTRING(mp.rendering_provider_license,1,30),'') END AS  Rendering_Provider_Secondary_Identifier ,CASE WHEN TRIM(UPPER(bh.form_type)) IN ('RX','P') THEN CASE WHEN TRIM(pl.dispensed_as_written_code) <> '' AND TRIM(pl.dispensed_as_written_code)IS NOT NULL THEN dispensed_as_written_code WHEN LOWER(bh.trading_partner)='jopari' AND UPPER(TRIM(pl.dispensed))='Y' THEN 9 WHEN LOWER(bh.trading_partner)='optum' AND UPPER(TRIM(pl.generic_dispensed))='Y' THEN 9 WHEN LOWER(bh.source)='kofax' AND UPPER(TRIM(pl.ndc_code))='Y' THEN 9 WHEN TRIM(UPPER(generic_available))='N' THEN 4 WHEN UPPER(TRIM(pl.dispensed_as_written_code))='Y' THEN CASE WHEN LOWER(bh.trading_partner)='jopari' AND UPPER(TRIM(pl.dispensed))='N' THEN 1 WHEN LOWER(bh.trading_partner)='optum' AND UPPER(TRIM(pl.generic_dispensed))='N' THEN 1 WHEN LOWER(bh.source)='kofax' AND UPPER(TRIM(pl.ndc_code))='N' THEN 1 ELSE '' END ELSE 9 END ELSE ''END AS Certification_DAW ,CASE WHEN LOWER(bh.trading_partner) IN ('align','techhealth')  THEN  'TX' WHEN LOWER(bh.trading_partner) IN ('optum')  THEN  'XX' ELSE '' END AS Message_Code_Modifier_Jurisdiction_1 ,CASE WHEN LOWER(bh.trading_partner) IN ('align','techhealth','optum')  THEN  '4000' ELSE '' END AS Message_Reduction_Code_1 ,CASE WHEN LOWER(bh.trading_partner) = 'jopari' THEN IF(TRIM(pr.rendering_record_type_physician_code)='60_82',COALESCE(SUBSTRING(mp.rendering_provider_npi,1,10),''),'') ELSE COALESCE(SUBSTRING(mp.rendering_provider_npi,1,10),'') END AS  Rendering_Provider_NPI ,CASE WHEN TRIM(UPPER(bh.form_type)) IN ('RX','P')  AND LOWER(bh.trading_partner) ='optum' THEN '' WHEN LOWER(bh.trading_partner) = 'jopari' THEN  IF(TRIM(pr.rendering_record_type_physician_code)='60_82' AND TRIM(mp.rendering_provider_license) IS NOT NULL AND TRIM(mp.rendering_provider_license) <> '' ,'0B','') WHEN LOWER(bh.source)='kofax' AND TRIM(UPPER(bh.form_type)) IN('PROF') THEN IF(TRIM(rendering_provider_other_id) IS NOT NULL AND TRIM(rendering_provider_other_id) <> '','0B','') ELSE CASE WHEN TRIM(mp.rendering_provider_license) <> '' AND TRIM(mp.rendering_provider_license) IS NOT NULL THEN '0B' ELSE '' END END AS Qualifier ,pl.line_number AS pharmacy_line_number ,ptl.line_number AS professional_line_number ,htl.line_number  AS hospitalization_line_number FROM txm_bitx.bill_header bh JOIN (SELECT txm_invoice_number ,status_type ,status FROM txm_bitx.invoice_status WHERE status_type='ADJUDICATION' AND status='READY_FOR_SUBMISSION' ) inv_stat ON inv_stat.txm_invoice_number=bh.txm_invoice_number LEFT OUTER JOIN (SELECT * FROM txm_bitx.professional_treatment )pt ON pt.bill_id=bh.bill_id AND CASE WHEN bh.form_type IN ('PROF') THEN 1=1 ELSE 1=0 END LEFT OUTER JOIN (SELECT * FROM txm_bitx.professional_treatment_line )ptl ON ptl.treatment_id=pt.treatment_id AND CASE WHEN bh.form_type IN ('PROF') THEN 1=1 ELSE 1=0 END LEFT OUTER JOIN (SELECT * FROM txm_bitx.pharmacy_line )pl ON pl.bill_id=bh.bill_id AND CASE WHEN bh.form_type IN ('RX','P') THEN 1=1 ELSE 1=0 END LEFT OUTER JOIN (select  bill_id ,provider_number ,referring_provider_npi ,referring_provider_state_license ,rendering_record_type_physician_code ,rendering_provider_other_id ,referring_record_type_physician_code FROM (SELECT bill_id ,provider_number ,referring_provider_npi ,referring_provider_state_license ,rendering_record_type_physician_code ,rendering_provider_other_id ,referring_record_type_physician_code ,ROW_NUMBER() OVER(PARTITION BY bill_id ORDER BY provider_number) AS rw FROM txm_bitx.provider WHERE provider_number IS NOT NULL )q where q.rw=1 ) pr ON pr.bill_id=bh.bill_id LEFT OUTER JOIN (SELECT * FROM txm_bitx.hospitalization_treatment ) ht ON ht. bill_id=bh.bill_id AND CASE WHEN bh.form_type IN ('INST','H') THEN 1=1 ELSE 1=0 END LEFT OUTER JOIN (SELECT * FROM txm_bitx.hospitalization_treatment_line )htl ON htl.hospitalization_treatment_id=ht.hospitalization_treatment_id AND CASE WHEN bh.form_type IN ('INST','H') THEN 1=1 ELSE 1=0 END LEFT OUTER JOIN freq ON freq.bill_id=bh.bill_id AND  freq.txm_invoice_number=bh.txm_invoice_number LEFT OUTER JOIN txm_bitx_provider.provider mp ON pr.provider_number=mp.provider_number WHERE bh.bill_header_id IS NOT NULL AND bh.txm_invoice_number IS NOT NULL ORDER BY bill_id )Q ORDER BY bill_id,COALESCE(pharmacy_line_number,hospitalization_line_number,professional_line_number,1)","db_read_sql_select_bu":"SELECT record_type, coalesce(client_code,'') AS client_code ,coalesce(bill_dcn,'') AS bill_dcn , udf_code, UDF_Owner_Flag, UDF_Data_Value FROM (SELECT 'BU' AS record_type ,CASE WHEN TRIM(bh.txm_claim_secure)='0' AND TRIM(UPPER(bh.txm_jurisdiction_code)) IN ('JA','LS') THEN  'TXLS' WHEN TRIM(bh.txm_claim_secure)='0' AND TRIM(UPPER(bh.txm_jurisdiction_code))='TX' THEN 'TX35' ELSE 'TX18' END AS Client_Code ,txm_invoice_number AS Bill_DCN ,'SOURCE' AS udf_code ,'C' AS UDF_Owner_Flag ,UPPER(TRIM(coalesce(bh.trading_partner,source)))  AS UDF_Data_Value ,1 AS seq_ord FROM txm_bitx.bill_header bh WHERE txm_invoice_number IN ( SELECT txm_invoice_number FROM txm_bitx.invoice_status WHERE status_type='ADJUDICATION' AND status='READY_FOR_SUBMISSION' ) AND txm_invoice_number IS NOT NULL AND file_header_id IS NOT NULL UNION ALL SELECT 'BU' AS record_type ,CASE WHEN TRIM(bh.txm_claim_secure)='0' AND TRIM(UPPER(bh.txm_jurisdiction_code)) IN ('JA','LS') THEN  'TXLS' WHEN TRIM(bh.txm_claim_secure)='0' AND TRIM(UPPER(bh.txm_jurisdiction_code))='TX' THEN 'TX35' ELSE 'TX18' END AS Client_Code ,txm_invoice_number AS Bill_DCN ,'TPID' AS udf_code ,'C' AS UDF_Owner_Flag ,CASE WHEN LOWER(TRIM(bh.trading_partner)) IN ('align') THEN COALESCE(SUBSTRING(UPPER(unique_bill_id),1,12),'') WHEN LOWER(TRIM(bh.trading_partner)) IN ('techhealth') THEN COALESCE(SUBSTRING(UPPER(unique_bill_id),1,12),'') WHEN LOWER(TRIM(bh.trading_partner)) IN ('jopari')  THEN COALESCE(SUBSTRING(UPPER(unique_bill_id),1,12),'') WHEN LOWER(TRIM(bh.trading_partner)) IN ('optum')  THEN COALESCE(SUBSTRING(UPPER(unique_bill_id),1,12),'') WHEN TRIM(UPPER(bh.source)) ='ECI' THEN TXM_invoice_number ELSE TXM_invoice_number END AS UDF_Data_Value ,2 AS seq_ord FROM txm_bitx.bill_header bh WHERE txm_invoice_number IN ( SELECT txm_invoice_number FROM txm_bitx.invoice_status WHERE status_type='ADJUDICATION' AND status='READY_FOR_SUBMISSION' ) AND txm_invoice_number IS NOT NULL AND file_header_id IS NOT NULL )q Order by bill_dcn,seq_ord","s3_file_prefix":"data/smart_advisor/outbound/bill_files/","outbound_file_name":"<date_format>.SBI","batch_number":"0","max_batch_number":"SELECT COALESCE(MAX(batch_number_file),-1) AS max_file_number FROM txm_bitx_enrichment_logs.batch_bill_file_master"}